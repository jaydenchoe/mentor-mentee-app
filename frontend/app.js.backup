// API Configuration
const API_BASE_URL = 'http://localhost:8080';

// Global State
let currentUser = null;
let authToken = null;
let demoUsers = []; // ë°ëª¨ ì‚¬ìš©ì ëª©ë¡
let currentPage = 'welcome'; // í˜„ì¬ í˜ì´ì§€
let previousPage = null; // ë°”ë¡œ ì´ì „ í˜ì´ì§€

// Load demo users from backend
async function loadDemoUsers() {
    try {
        demoUsers = await apiCall('/api/demo-users');
        console.log('ë°ëª¨ ì‚¬ìš©ìë“¤ ë¡œë“œë¨:', demoUsers);
    } catch (error) {
        console.error('ë°ëª¨ ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
        // í´ë°± ë°ì´í„°
        demoUsers = [
        loadMatchRequests('received'); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (error) {
        showToast('ì‘ë‹µ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
};
        // í´ë°± ë°ì´í„°
        demoUsers = [
            {
                email: 'mentor1@example.com',
                password: 'password123',
                name: 'ê¹€ë©˜í† ',
                role: 'mentor',
                avatar: 'ğŸ‘¨â€ğŸ’»',
                description: 'í”„ë¡ íŠ¸ì—”ë“œ ì „ë¬¸ê°€'
            },
            {
                email: 'mentor2@example.com',
                password: 'password123',
                name: 'ì´ë©˜í† ',
                role: 'mentor',
                avatar: 'ğŸ‘©â€ğŸ’¼',
                description: 'ë°±ì—”ë“œ ì „ë¬¸ê°€'
            },
            {
                email: 'mentee1@example.com',
                password: 'password123',
                name: 'ë°•ë©˜í‹°',
                role: 'mentee',
                avatar: 'ğŸ§‘â€ğŸ“',
                description: 'ì‹ ì… ê°œë°œì'
            },
            {
                email: 'mentee2@example.com',
                password: 'password123',
                name: 'ìµœë©˜í‹°',
                role: 'mentee',
                avatar: 'ğŸ‘©â€ğŸ“',
                description: 'ì·¨ì—… ì¤€ë¹„ìƒ'
            }
        ];
    }
}

// Utility Functions
function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function hideAllSections() {
    const sections = ['welcome', 'login', 'iconLogin', 'signup', 'dashboard', 'profile', 'mentors', 'matches'];
    sections.forEach(section => {
        const element = document.getElementById(section);
        if (element) {
            element.style.display = 'none';
        }
    });
}

function updateNavigation() {
    const nav = document.getElementById('nav');
    
    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ HTML (ì´ì „ í˜ì´ì§€ê°€ ìˆê³  welcomeì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    const backButton = (previousPage && previousPage !== 'welcome') ? 
        `<button class="btn btn-back" onclick="goBack()" title="ì´ì „ í™”ë©´ìœ¼ë¡œ">
            â† ë’¤ë¡œ
        </button>` : '';
    
    if (currentUser) {
        nav.innerHTML = `
            ${backButton}
            <div class="nav-user-info">
                <span>ì•ˆë…•í•˜ì„¸ìš”, ${currentUser.name}ë‹˜</span>
                <button class="btn btn-secondary" onclick="showDashboard()">ëŒ€ì‹œë³´ë“œ</button>
                <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        `;
    } else {
        nav.innerHTML = `
            ${backButton}
            <div class="nav-auth-buttons">
                <button class="btn btn-primary" onclick="showManualLogin()">ë¡œê·¸ì¸</button>
                <button class="btn btn-secondary" onclick="showSignup()">íšŒì›ê°€ì…</button>
            </div>
        `;
    }
}

// API Functions
async function apiCall(endpoint, options = {}) {
    const url = `${API_BASE_URL}${endpoint}`;
    const config = {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        ...options
    };

    if (authToken) {
        config.headers['Authorization'] = `Bearer ${authToken}`;
    }

    try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || data.message || 'API í˜¸ì¶œ ì‹¤íŒ¨');
        }
        
        return data;
    } catch (error) {
        throw new Error(error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

// Authentication Functions
async function login(email, password) {
    showLoading();
    try {
        const data = await apiCall('/api/auth/login', {
            method: 'POST',
            body: JSON.stringify({ email, password })
        });
        
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        updateNavigation();
        showDashboard();
        showToast('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
        showToast(error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function signup(name, email, password, role) {
    showLoading();
    try {
        await apiCall('/api/auth/register', {
            method: 'POST',
            body: JSON.stringify({ name, email, password, role })
        });
        
        showToast('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
        showLogin();
    } catch (error) {
        showToast(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function logout() {
    authToken = null;
    currentUser = null;
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    
    // í˜ì´ì§€ ìƒíƒœ ì´ˆê¸°í™”
    currentPage = 'welcome';
    previousPage = null;
    
    updateNavigation();
    showWelcome();
    showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// Profile Functions
async function loadProfile() {
    if (!currentUser) return;
    
    try {
        const profile = await apiCall(`/api/users/${currentUser.id}/profile`);
        
        document.getElementById('name').value = profile.name || '';
        document.getElementById('bio').value = profile.bio || '';
        document.getElementById('skillsets').value = profile.skills ? profile.skills.join(', ') : '';
        
        // ê¸°ë³¸ ì´ë¯¸ì§€ URL ì„¤ì • (ì‚¬ìš©ì ìŠ¤í† ë¦¬ ìš”êµ¬ì‚¬í•­)
        const defaultImageUrl = currentUser.role === 'mentor' 
            ? 'https://placehold.co/500x500.jpg?text=MENTOR'
            : 'https://placehold.co/500x500.jpg?text=MENTEE';
            
        if (profile.profile_image) {
            document.getElementById('profile-photo').src = `${API_BASE_URL}/uploads/${profile.profile_image}`;
        } else {
            document.getElementById('profile-photo').src = defaultImageUrl;
        }
    } catch (error) {
        showToast('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

async function saveProfile() {
    showLoading();
    try {
        const name = document.getElementById('name').value;
        const bio = document.getElementById('bio').value;
        const skillsText = document.getElementById('skillsets').value;
        const skills = skillsText ? skillsText.split(',').map(s => s.trim()) : [];
        
        await apiCall(`/api/users/${currentUser.id}/profile`, {
            method: 'PUT',
            body: JSON.stringify({ name, bio, skills })
        });
        
        currentUser.name = name;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateNavigation();
        
        showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
        showToast('í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function uploadProfileImage() {
    const input = document.getElementById('profile');
    const file = input.files[0];
    
    if (!file) return;
    
    showLoading();
    try {
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch(`${API_BASE_URL}/api/users/${currentUser.id}/profile/image`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            },
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        document.getElementById('profileImg').src = `${API_BASE_URL}/uploads/${data.filename}`;
        
        showToast('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
        showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Mentor Functions
async function loadMentors(search = '', sortBy = 'name') {
    showLoading();
    try {
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (sortBy) params.append('sort', sortBy);
        
        const mentors = await apiCall(`/api/mentors?${params.toString()}`);
        displayMentors(mentors);
    } catch (error) {
        showToast('ë©˜í†  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function displayMentors(mentors) {
    const container = document.getElementById('mentorsList');
    
    if (mentors.length === 0) {
        container.innerHTML = '<p class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    container.innerHTML = mentors.map(mentor => `
        <div class="mentor-card mentor">
            <div class="mentor-header">
                <img src="${mentor.profile_image ? `${API_BASE_URL}/uploads/${mentor.profile_image}` : 'https://placehold.co/500x500.jpg?text=MENTOR'}" 
                     alt="${mentor.name}" class="mentor-avatar">
                <div class="mentor-info">
                    <h3>${mentor.name}</h3>
                    <p>${mentor.role}</p>
                </div>
            </div>
            <p>${mentor.bio || 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
            <div class="mentor-skills">
                ${(mentor.skills || []).map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
            </div>
            <div class="request-section">
                <textarea id="message" data-mentor-id="${mentor.id}" data-testid="message-${mentor.id}" 
                         placeholder="ë©˜í† ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                <div id="request-status" class="request-status"></div>
                <button id="request" class="btn btn-primary btn-full" onclick="sendMatchRequest(${mentor.id})">
                    ë§¤ì¹­ ìš”ì²­
                </button>
            </div>
        </div>
    `).join('');
}

async function searchMentors() {
    const search = document.getElementById('search').value;
    const sortBy = document.getElementById('sortSelect').value;
    await loadMentors(search, sortBy);
}

// Match Functions
async function sendMatchRequest(mentorId) {
    if (!currentUser) {
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    // ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
    const messageElement = document.querySelector(`[data-mentor-id="${mentorId}"]`);
    const message = messageElement ? messageElement.value.trim() : '';
    
    if (!message) {
        showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    showLoading();
    try {
        // ê¸°ì¡´ ìš”ì²­ í™•ì¸ (ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
        const existingRequests = await apiCall('/api/match-requests/outgoing');
        const hasPendingRequest = existingRequests.some(req => 
            req.mentor_id === mentorId && req.status === 'pending'
        );
        
        if (hasPendingRequest) {
            showToast('ì´ë¯¸ í•´ë‹¹ ë©˜í† ì—ê²Œ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        await apiCall('/api/match-requests', {
            method: 'POST',
            body: JSON.stringify({ 
                mentor_id: mentorId,
                message: message 
            })
        });
        
        // ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
        const statusElement = messageElement.parentElement.querySelector('#request-status');
        if (statusElement) {
            statusElement.textContent = 'ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤';
            statusElement.className = 'request-status sent';
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        const buttonElement = messageElement.parentElement.querySelector('#request');
        if (buttonElement) {
            buttonElement.textContent = 'ìš”ì²­ ì „ì†¡ë¨';
            buttonElement.disabled = true;
        }
        
        showToast('ë§¤ì¹­ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
    } catch (error) {
        showToast('ë§¤ì¹­ ìš”ì²­ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function loadMatchRequests(type = 'received') {
    showLoading();
    try {
        const endpoint = type === 'received' ? '/api/match-requests/incoming' : '/api/match-requests/outgoing';
        const matches = await apiCall(endpoint);
        displayMatches(matches, type);
    } catch (error) {
        showToast('ë§¤ì¹­ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function displayMatches(matches, type) {
    const container = document.getElementById('matchesList');
    
    if (matches.length === 0) {
        container.innerHTML = '<p class="text-center">ë§¤ì¹­ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    container.innerHTML = matches.map(match => {
        const user = type === 'received' ? match.mentee : match.mentor;
        const statusClass = `status-${match.status}`;
        const statusText = {
            'pending': 'ëŒ€ê¸°ì¤‘',
            'accepted': 'ìˆ˜ë½ë¨',
            'rejected': 'ê±°ì ˆë¨'
        }[match.status];
        
        return `
            <div class="match-card">
                <div class="match-header">
                    <div class="match-user">
                        <img src="${user.profile_image ? `${API_BASE_URL}/uploads/${user.profile_image}` : 
                            (user.role === 'mentor' ? 'https://placehold.co/500x500.jpg?text=MENTOR' : 'https://placehold.co/500x500.jpg?text=MENTEE')}" 
                             alt="${user.name}" class="match-avatar">
                        <div>
                            <h4>${user.name}</h4>
                            <p>${user.role}</p>
                        </div>
                    </div>
                    <div class="match-status ${statusClass}">${statusText}</div>
                </div>
                <div class="request-message" mentee="${type === 'received' ? user.id : ''}">${match.message || 'ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>
                <p class="text-muted">ìš”ì²­ì¼: ${new Date(match.created_at).toLocaleDateString()}</p>
                ${match.status === 'pending' ? getMatchActions(match, type) : ''}
            </div>
        `;
    }).join('');
}

function getMatchActions(match, type) {
    if (type === 'received') {
        return `
            <div class="match-actions">
                <button id="accept" class="btn btn-success" onclick="respondToMatch(${match.id}, 'accepted')">ìˆ˜ë½</button>
                <button id="reject" class="btn btn-danger" onclick="respondToMatch(${match.id}, 'rejected')">ê±°ì ˆ</button>
            </div>
        `;
    } else {
        return `
            <div class="match-actions">
                <button class="btn btn-danger" onclick="cancelMatchRequest(${match.id})">ìš”ì²­ ì·¨ì†Œ</button>
            </div>
        `;
    }
}

async function respondToMatch(matchId, response) {
    showLoading();
    try {
        await apiCall(`/api/match-requests/${matchId}/respond`, {
            method: 'POST',
            body: JSON.stringify({ action: response })
        });
        
        showToast(`ë§¤ì¹­ì„ ${response === 'accepted' ? 'ìˆ˜ë½' : 'ê±°ì ˆ'}í–ˆìŠµë‹ˆë‹¤`, 'success');
        loadMatchRequests('received');
    } catch (error) {
        showToast('ì‘ë‹µ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function cancelMatchRequest(matchId) {
    showLoading();
    try {
        await apiCall(`/api/match-requests/${matchId}`, {
            method: 'DELETE'
        });
        
        showToast('ë§¤ì¹­ ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤', 'success');
        loadMatchRequests('sent');
    } catch (error) {
        showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Quick Login for Demo Users - ê°„ë‹¨í•œ ë²„ì „ (ê³„ì •ì´ ì´ë¯¸ ì¡´ì¬í•œë‹¤ê³  ê°€ì •)
async function quickLogin(email, password) {
    console.log('QuickLogin ì‹œì‘:', email);
    showLoading();
    try {
    // ìë™ìœ¼ë¡œ ì…ë ¥ê°’ ì„¤ì •
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    if (emailInput) emailInput.value = email;
    if (passwordInput) passwordInput.value = password;
        
        // ë¡œê·¸ì¸ ìˆ˜í–‰
        console.log('ë¡œê·¸ì¸ ì‹œë„ ì¤‘...');
        await login(email, password);
        
        showToast(`${email}ë¡œ ìë™ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`, 'success');
    } catch (error) {
        console.log('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error.message);
        showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Create Demo Users (ì´ì œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ë°±ì—”ë“œì—ì„œ ë¯¸ë¦¬ ìƒì„±ë¨)
async function createDemoUser(email, password) {
    // ë” ì´ìƒ í•„ìš”ì—†ìŒ - ë°±ì—”ë“œì—ì„œ ë¯¸ë¦¬ ìƒì„±
    return;
}

// Navigation Functions
function showWelcome() {
    hideAllSections();
    document.getElementById('welcome').style.display = 'block';
    navigateToPage('welcome');
}

function showManualLogin() {
    hideAllSections();
    document.getElementById('login').style.display = 'block';
    navigateToPage('login');
}

function showIconLogin() {
    hideAllSections();
    document.getElementById('iconLogin').style.display = 'block';
    navigateToPage('iconLogin');
    
    // ì•„ì´ì½˜ ë¡œê·¸ì¸ í˜ì´ì§€ì˜ ë°ëª¨ ì‚¬ìš©ìë“¤ì„ ë™ì ìœ¼ë¡œ ìƒì„±
    updateIconLoginUsers();
}

// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í•¨ìˆ˜
function showLogin() {
    showManualLogin();
}

// ì•„ì´ì½˜ ë¡œê·¸ì¸ í˜ì´ì§€ì˜ ë°ëª¨ ì‚¬ìš©ìë“¤ ì—…ë°ì´íŠ¸
function updateIconLoginUsers() {
    const mentorGrid = document.getElementById('mentorLoginGrid');
    const menteeGrid = document.getElementById('menteeLoginGrid');
    
    if (demoUsers.length > 0) {
        // ë©˜í† ì™€ ë©˜í‹° ë¶„ë¦¬
        const mentors = demoUsers.filter(user => user.role === 'mentor');
        const mentees = demoUsers.filter(user => user.role === 'mentee');
        
        // ë©˜í†  ì˜ì—­ ì—…ë°ì´íŠ¸
        if (mentorGrid) {
            mentorGrid.innerHTML = mentors.map(user => `
                <div class="demo-user mentor-user" onclick="quickLogin('${user.email}', '${user.password}')">
                    <div class="demo-avatar ${user.role}">${user.avatar}</div>
                    <span>${user.name}</span>
                    <small>${user.description}</small>
                </div>
            `).join('');
        }
        
        // ë©˜í‹° ì˜ì—­ ì—…ë°ì´íŠ¸
        if (menteeGrid) {
            menteeGrid.innerHTML = mentees.map(user => `
                <div class="demo-user mentee-user" onclick="quickLogin('${user.email}', '${user.password}')">
                    <div class="demo-avatar ${user.role}">${user.avatar}</div>
                    <span>${user.name}</span>
                    <small>${user.description}</small>
                </div>
            `).join('');
        }
    }
}

function showSignup() {
    hideAllSections();
    document.getElementById('signup').style.display = 'block';
    navigateToPage('signup');
}

function showDashboard() {
    if (!currentUser) {
        showLogin();
        return;
    }
    hideAllSections();
    document.getElementById('dashboard').style.display = 'block';
    navigateToPage('dashboard');
}

function showProfile() {
    if (!currentUser) {
        showLogin();
        return;
    }
    hideAllSections();
    document.getElementById('profile').style.display = 'block';
    loadProfile();
    navigateToPage('profile');
}

function showMentors() {
    hideAllSections();
    document.getElementById('mentors').style.display = 'block';
    loadMentors();
    navigateToPage('mentors');
}

function showMatches() {
    if (!currentUser) {
        showLogin();
        return;
    }
    hideAllSections();
    document.getElementById('matches').style.display = 'block';
    loadMatchRequests('received');
    navigateToPage('matches');
}

function showMatchTab(type) {
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    const activeTab = type === 'received' ? tabs[0] : tabs[1];
    activeTab.classList.add('active');
    
    loadMatchRequests(type);
}

// Page Navigation Management
function navigateToPage(page) {
    // ì´ì „ í˜ì´ì§€ ì €ì¥ (welcomeì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    if (currentPage !== 'welcome') {
        previousPage = currentPage;
    }
    currentPage = page;
    updateNavigation();
}

function goBack() {
    if (previousPage) {
        // ê°„ë‹¨íˆ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
        switch(previousPage) {
            case 'welcome':
                showWelcome();
                break;
            case 'login':
                showManualLogin();
                break;
            case 'iconLogin':
                showIconLogin();
                break;
            case 'signup':
                showSignup();
                break;
            case 'dashboard':
                showDashboard();
                break;
            case 'profile':
                showProfile();
                break;
            case 'mentors':
                showMentors();
                break;
            case 'matches':
                showMatches();
                break;
            default:
                showWelcome();
        }
    }
}

// App Initialization
async function initializeApp() {
    // Initialize current page
    currentPage = 'welcome';
    previousPage = null;
    
    // Load demo users first
    await loadDemoUsers();
    
    // Check for existing auth token
    const savedToken = localStorage.getItem('authToken');
    const savedUser = localStorage.getItem('currentUser');
    
    if (savedToken && savedUser) {
        authToken = savedToken;
        currentUser = JSON.parse(savedUser);
        navigateToPage('dashboard');
        showDashboard();
    } else {
        showWelcome();
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load saved authentication state
    const savedToken = localStorage.getItem('authToken');
    const savedUser = localStorage.getItem('currentUser');
    
    if (savedToken && savedUser) {
        authToken = savedToken;
        currentUser = JSON.parse(savedUser);
        updateNavigation();
        showDashboard();
    } else {
        showWelcome();
    }
    
    // Form event listeners
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        login(email, password);
    });
    
    document.getElementById('signupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;
        signup(name, email, password, role);
    });
    
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfile();
    });
    
    document.getElementById('profile').addEventListener('change', uploadProfileImage);
    
    // Search functionality
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchMentors();
        }
    });
});
